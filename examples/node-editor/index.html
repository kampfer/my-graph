<script type="module">
    import { NetworkGraph } from '../../dist/graph.js';

    function random(n) { // 生成n位长度的字符串
        var str = "abcdefghijklmnopqrstuvwxyz0123456789"; // 可以作为常量放到random外面
        var result = "";
        for (var i = 0; i < n; i++) {
            result += str[parseInt(Math.random() * str.length)];
        }
        return result;
    }

    function makeData(nodeCount, edgeCount) {
        const data = { nodes: [], edges: [] };
        for (let i = 0; i < nodeCount; i++) {
            let id = random(10);
            data.nodes.push({
                id,
                label: id
            });
        }
        for (let i = 0; i < edgeCount; i++) {
            let id = random(10);
            let target = randomNode(data);
            let source = randomNode(data);
            while (source === target) {
                target = randomNode(data);
            }
            data.edges.push({
                id,
                label: id,
                source: source.id,
                target: target.id,
            });
        }
        return data;
    }

    function init() {
        NetworkGraph.registerBehavior('connect-node', {
            events: {
                'dragstart.node': 'handleDragstart',
                'drag.node': 'handleDrag',
                'dragend.node': 'handleDragend',
                'mouseenter.node': 'handleMouseenter',
                'mouseleave.node': 'handleMouseleave',
            },
            handleDragstart(e, d) {
                if (!this.link) {
                    this.link = this.graph.gSelection.append('path')
                        .attr('marker-end', `url(#arrow-default)`)
                        .attr('stroke', '#000');
                } else {
                    this.link.style('display', 'unset');
                }
                this.start = d;
            },
            handleDrag(e, d) {
                if (this.end) {
                    this.link.attr('d', `M ${this.start.x} ${this.start.y} L ${this.end.x} ${this.end.y}`);
                } else {
                    this.link.attr('d', `M ${this.start.x} ${this.start.y} L ${e.x} ${e.y}`);
                }
            },
            handleDragend(e, d) {
                this.link.style('display', 'none');
                // 必须把d重置，否则下次操作时，边会闪烁一次
                this.link.attr('d', `M ${this.start.x} ${this.start.y}`);
                if (this.end) {
                    console.log('add');
                    const id = random(10);
                    this.graph.addEdge({
                        id,
                        label: id,
                        source: this.start,
                        target: this.end
                    });
                }
            },
            handleMouseenter(e, d) {
                if (d !== this.start) {
                    this.end = d;
                }
            },
            handleMouseleave(e, d) {
                this.end = null;
            }
        });

        const graph = new NetworkGraph({
            container: 'body',
            width: window.innerWidth,
            height: window.innerHeight,
            behaviors: ['connect-node', 'zoom']
        });

        // graph.unuseBehavior('connect-node');

        graph.render(makeData(10, 0));
    }

    init();
</script>